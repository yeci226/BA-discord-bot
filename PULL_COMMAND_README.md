# 抽卡命令功能说明

## 概述

新增了一个名为 `/pull` 的Discord斜线命令，允许用户指定目标角色进行10抽模拟。

## 功能特点

### 1. 指定角色抽卡
- 用户可以通过角色名称或ID指定目标角色（仅限3星角色）
- 支持自动完成功能，输入角色名称时会显示匹配的3星角色列表

### 2. 抽卡机率系统
参考 [ba-gacha](https://github.com/U1805/ba-gacha) 仓库的抽卡机率实现：

- **1星角色**: 78.5% 概率
- **2星角色**: 18.5% 概率  
- **3星角色**: 3% 概率
- **UP角色**: 从对应星级的总概率中分走特定比例
  - UP 3星角色: 占3星总概率的0.7%
  - UP 2星角色: 占2星总概率的3%

### 3. 角色池限制规则
- **目标角色限制**: 只能指定3星角色作为目标
- **活动角色排除**: 不会出现IsLimited为3的活动限定角色
- **角色池过滤规则**:
  - 目标角色IsLimited为0（常驻）: 只出现IsLimited为0的角色
  - 目标角色IsLimited为1（限定1）: 出现IsLimited为0和1的角色
  - 目标角色IsLimited为2（限定2）: 出现IsLimited为0、1和2的角色

### 4. 抽卡结果展示
- 生成包含10个角色卡片的图片
- 显示每个角色的图标、名称和星级
- 目标角色会有红色边框标记
- 显示是否抽到目标角色和三星角色
- 根据抽卡结果显示不同的动画信息
- 模拟动画播放过程：normal 或 special
- 在动画播放时显示目标角色头像
- 在抽卡结果卡片上添加圆形角色头像
- 采用游戏原版风格的界面设计
  - 浅蓝色渐变背景
  - 白色圆角卡片
  - 彩色边框表示星级
  - 卡片阴影效果

## 使用方法

### 基本用法
```
/pull target:角色名称或ID
```

### 示例
```
/pull target:星野
/pull target:10005
```

## 命令参数

| 参数 | 类型 | 必需 | 描述 |
|------|------|------|------|
| target | String | 是 | 目标角色名称或ID |

## 返回结果

1. **动画信息**: 显示动画类型、播放时间和状态
2. **文字描述**: 显示目标角色、是否抽到目标角色、是否获得三星、抽卡次数
3. **图片展示**: 10张角色卡片，按5x2网格排列

### 结果示例
```
🎬 抽卡動畫
正在抽取三星角色...

動畫類型: special
播放時間: 9.4秒
狀態: 播放中...

🎉 恭喜抽到三星！
**目標角色:** 星野 ✅
**獲得三星:** ✅
**抽卡次數:** 10次
```

## 技术实现

### 核心类
- `GachaSimulator`: 抽卡模拟器类
  - 构建抽卡数据库
  - 实现Fisher-Yates洗牌算法
  - 根据机率随机抽取角色

### 图片生成
- 使用 `@napi-rs/canvas` 生成抽卡结果图片
- 支持角色图标加载和星级显示
- 目标角色特殊标记
- 智能图标处理：
  - 自动移除enemyinfo_前缀
  - 处理null/undefined图标值
  - 备用方案使用学生ID
  - 占位符显示问号

### 动画系统
- 根据抽卡结果选择不同的动画类型
- 三星结果显示special动画信息
- 非三星结果显示normal动画信息
- 模拟8秒的动画播放过程
- 动画播放完成后显示最终抽卡结果
- 使用在线GIF动画链接，支持实时播放
- 在动画播放时显示目标角色头像
- 并行处理图片绘制和动画播放，优化用户体验

### 数据来源
- 通过 `getStudentsData()` 获取学生数据
- 支持角色名称翻译 (`smartTranslate`)

## 文件结构

```
src/commands/slash/ba/pull.ts  # 主要命令文件
src/events/auto-complete.ts    # 自动完成功能
```

## 依赖项

- `discord.js`: Discord API
- `@napi-rs/canvas`: 图片生成
- `queue`: 队列管理
- `axios`: 数据获取

## 注意事项

1. 角色图标需要网络连接才能正常显示
2. 抽卡结果是随机生成的，每次结果可能不同
3. 机率系统基于游戏官方数据，但仅供娱乐参考
4. 图片生成可能需要几秒钟时间，请耐心等待
5. 只能指定3星角色作为目标角色
6. 活动限定角色（IsLimited为3）不会出现在抽卡池中
7. 动画播放需要9.4秒时间，请耐心等待完整过程

## 未来改进

- [ ] 添加更多抽卡池类型
- [ ] 支持自定义抽卡次数
- [ ] 添加抽卡历史记录
- [ ] 优化图片生成性能
- [x] 添加更多视觉效果
  - [x] 使用在线GIF动画链接替换本地视频文件
  - [x] 在动画播放时显示目标角色头像
  - [x] 在抽卡结果卡片上添加角色头像
  - [x] 重新设计抽卡结果界面，更接近游戏原版
- [x] 修复图标加载问题，处理enemyinfo_前缀和null值
- [x] 性能优化
  - [x] 并行处理图片绘制和动画播放，减少等待时间
  - [x] 优化等待时间为8秒，平衡用户体验
  - [x] 简化角色图片加载逻辑，提高成功率 